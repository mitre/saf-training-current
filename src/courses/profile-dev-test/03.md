---
order: 3
next: 04.md
title: Environment Setup
author: Aaron Lippold
---

# Required Software

- [RVM](https://rvm.io/), or another Ruby Management Tool
- Ruby v3 or higher
- Git
- [Test Kitchen](https://docs.chef.io/workstation/kitchen/)
- VS Code or another IDE
- Docker (if you want to test hardened and non-hardened containers)
- AWS CLI
- AWS Account

## Bundler

[Bundler](https://bundler.io/) is Ruby's dependency manager (think `pip` for Python, or `npm` for NodeJS). Since InSpec is ultimately Ruby code, Bundler is how we're going to keep our development environment squared up.

### The Gemfile

You tell Bundler what Ruby dependencies ("gems") you want available by listing them out in a file called (appropriately) `Gemfile` at the root or your project.

InSpec profiles occasionally require you to download gems to support individual tests. If this is the case, they should be listed in the Gemfile. This is also how we install the Test Kitchen suite (`test-kitchen`).

Here's an example from the [RHEL 8 STIG profile](https://github.com/mitre/redhat-enterprise-linux-8-stig-baseline/blob/main/Gemfile):
``` ruby
source 'https://rubygems.org'

gem 'cookstyle'
gem 'highline'
gem 'inspec', '>= 6.6.0'
gem 'inspec-bin'
gem 'inspec-core'
gem 'kitchen-ansible'
gem 'kitchen-docker'
gem 'kitchen-dokken'
gem 'kitchen-ec2'
gem 'kitchen-inspec'
gem 'kitchen-sync'
gem 'kitchen-vagrant'
gem 'pry-byebug'
gem 'rake'
gem 'rubocop'
gem 'rubocop-rake'
gem 'test-kitchen'
gem 'train-awsssm'
```

Running the command `bundle install` inside your profile repo will cause Bundler to read your Gemfile and install every listed gem (which the docs call your 'gem bundle'). See the Bundler docs linked above for more details.

::: Note Wait, does that gem say `inspec`?
Correct. For convenience, we on the SAF team tend to install InSpec itself as a gem (since it is, after all, just Ruby code under the hood). Note that installing InSpec this way _can_ cause confusion if you install it alongside one of the regular executable releases (i.e. from the Chef downloads page, or via `brew install inspec` or similar), which actually include their own little Ruby environment internally. This is why we need to use `bundle exec` to _force_ commands to use the locally configured Ruby environment, including the "local" InSpec exectuable, as discussed in the next section.
:::

### bundle exec

Note that running `bundle install` does not mean that every subsequent time you run InSpec it will correctly use your Gemfile's gem bundle. If you want to _force_ a command to run in the context of the gem bundle, you append it with `bundle exec`.

This is why most of the commands in the rest of this guide have a `bundle exec` in front of them.

## RVM

We use the Ruby Version Manager to segregate our development environment for Ruby from the rest of our system. Think `venv` for Python. Make sure you [install RVM](https://rvm.io/rvm/install) and use a [gemset](https://rvm.io/gemsets/basics) for each profile you want to run.

::: note Doesn't that seem like overkill for just writing a few tests?
It isn't overkill.

Trust us; if you don't take the time to configure your environment to do this stuff, you will eventually wish you had.
:::

# Required Accounts

1. [AWS Console Account](https://aws.amazon.com/console/ "AWS Console Account")
2. [Platform One Account](https://login.dso.mil/register "Platform One Account") (used for container testing)
3. [P1 Harbor Token](https://login.dso.mil/auth/realms/baby-yoda/protocol/openid-connect/auth?client_id=harbor&redirect_uri=https%3A%2F%2Fregistry1.dso.mil%2Fc%2Foidc%2Fcallback&response_type=code&scope=openid+profile+email+offline_access&state=WS3BsNb5JevECV4aiy3irfegFETBHfRd "DSO Harbor Login") (used for container testing)

# Test Suite Environment Variables

1. Environment Variables used by Test Kitchen

- `INSPEC_CONTROL`: Specifies which single control to run in the `bundle exec kitchen verify` phase, useful for testing and debugging a single requirement.
  - default: `none`
- `KITCHEN_LOCAL_YAML`: Specifies the target testing environment you want to use to run and validate the profile.
  - default: `none`
- `VANILLA_CONTAINER_IMAGE`: Specifies the Docker container image you consider 'not hardened' (used by `kitchen.container.yml`).
  - default: `registry.access.redhat.com/ubi8/ubi:8.9-1028`
- `HARDENED_CONTAINER_IMAGE`: Specifies the Docker container image you consider 'hardened' (used by `kitchen.container.yml`).
  - default: `registry1.dso.mil/ironbank/redhat/ubi/ubi8`

2. AWS Environment

You can either use standard AWS Profiles to configure your environment or use the standard AWS Environment variables to run the test suite. See: [AWS CLI Installation & Configuration](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html "AWS CLI Install Guide")

- Use the `AWS_PROFILE` environment variable and AWS Credential Profiles to simplify testing on multiple AWS environments or segments. This will allow you to easily manage multiple sets of AWS secrets and access keys with adjustments to a single variable. (See: [AWS CLI and Profile Setup](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html "AWS CLI Profiles Setup"))

# Setting Up Your Environment

1. Set up your Ruby Version Management system.
2. Install Ruby 3.1 or higher.
3. Configure OpenSSL, organization certificates, etc., for your environment and tooling.
4. Set up your AWS CLI.
5. Clone the repository.
6. Obtain your [Harbor CLI Secret](https://registry1.dso.mil/harbor/projects "DSO Harbor Projects Page").
7. After logging in, click on your User Profile "About" to get the token.
8. Log in to the P1 Docker Registry.
9. Use the command `docker login -u {PI USER NAME} -p '{HARBOR CLI SECRET}' registry1.dso.mil`.
10. Run `bundle install` in your isolated Ruby environment.

# Post-Setup Checks

- Verify your newly installed Ruby environment by running `ruby --version`.
- Confirm that InSpec was installed by running `bundle exec inspec --version`.
- Check that Test Kitchen was installed by running `bundle exec kitchen version`.
- Verify that your `aws-cli` is correctly configured by running `aws s3 ls` (or your preferred test command for AWS CLI).
- Confirm your bundle installation by running `bundle exec inspec --version`.
- Verify you can pull from RepoOne by running `docker pull https://repo1.dso.mil/dsop/redhat/ubi/ubi8`.
- Celebrate üéâÔ∏è if everything went well.